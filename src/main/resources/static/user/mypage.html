<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <script>
        // âœ… í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        // const userId = localStorage.getItem('userId');
        // fetch(`/user-game/my-participations?userId=${userId}`)
        function loadCurrentUserAndMatches() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
                return;
            }

            // ğŸŸ¢ 1ë‹¨ê³„: /auth/user/me í˜¸ì¶œí•´ì„œ userId ê°€ì ¸ì˜¤ê¸°
            fetch('/auth/user/me', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨');
                    }
                    return response.json();
                })
                .then(userData => {
                    const userId = userData.userId;  // âœ… ì´ì œ userIdë¥¼ ì—¬ê¸°ì„œ ê°€ì ¸ì˜´
                    document.getElementById('nickname').innerText = userData.nickname;

                    // ğŸŸ¢ 2ë‹¨ê³„: ê°€ì ¸ì˜¨ userIdë¡œ ë§¤ì¹­ ëª©ë¡ ì¡°íšŒ
                    loadMyParticipations(userId);
                })
                .catch(error => {
                    console.error(error);
                    alert("ìœ ì € ì •ë³´ ë¡œë”© ì‹¤íŒ¨");
                });
        }

        // âœ… ë‚´ ì°¸ì—¬ ë§¤ì¹­ ëª©ë¡ ì¡°íšŒ
        function loadMyParticipations(userId) {
            const status = document.getElementById('statusSelect').value;
            const before = document.getElementById('beforeDate').value;
            const after = document.getElementById('afterDate').value;

            let url = `/user-game/my-participations?userId=${userId}`;

            if (status) url += `&status=${status}`;
            if (before) url += `&before=${before}:00`; // datetime-local ì€ ì´ˆê°€ ë¹ ì§€ë¯€ë¡œ ë³´ì •
            if (after) url += `&after=${after}:00`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const listEl = document.getElementById('participationList');
                    listEl.innerHTML = '';  // ì´ˆê¸°í™”
                    data.forEach(match => {
                        const li = document.createElement('li');
                        li.textContent = `ë§¤ì¹­ ID: ${match.id} | ì¥ì†Œ: ${match.location} | ë‚ ì§œ: ${match.time}`;

                        const  cancelBtn = document.createElement('button');
                        cancelBtn.textContent = 'ì°¸ê°€ ì·¨ì†Œ';
                        cancelBtn.onclick = () => cancelParticipation(userId, match.id);

                        const hostCancelBtn = document.createElement('button');
                        hostCancelBtn.textContent = 'ê²½ê¸° ì·¨ì†Œ';
                        hostCancelBtn.onclick = () => cancelParticipation(userid, match.id);

                        li.appendChild(cancelBtn);
                        li.appendChild(hostCancelBtn);

                        listEl.appendChild(li);
                    });
                });
        }
    // ì°¸ì—¬ìê°€ ë§¤ì¹­ ì·¨ì†Œ
        function cancelParticipation (userId, gameId) {
            fetch(`/user-game/${gameId}/cancel?userId=${userId}`, {
                method: 'POST'
            })
            .then( response => response.text())
                .then(msg => {
                    alert(msg);
                    loadMyParticipations(userId);
                });
        }

        function deleteMatch(userId, gameId) {
            fetch(`user-game/${gameId}?userId=${userId}`, {
                method: 'DELETE'
            })
                .then (response => response.text())
                .then (msg => {
                    alert(msg);
                    loadMyParticipations(userId);
                });
        }
        // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
        window.onload = loadCurrentUserAndMatches;
    </script>
</head>
<body>
<h2>ë‚´ ì •ë³´ (ë§ˆì´í˜ì´ì§€)</h2>
<p>ë‹‰ë„¤ì„: <span id="nickname"></span></p>
<hr>
<a href="../index.html">í™ˆ í™”ë©´</a>

<h3>âœ… ë‚´ê°€ ì°¸ê°€í•œ ë§¤ì¹­ ëª©ë¡</h3>
<select id="statusSelect">
    <option value="">ì „ì²´</option>
    <option value="COMPLETED">ì™„ë£Œ</option>
    <option value="CANCELLED">ì·¨ì†Œë¨</option>
</select>

<!-- ë‚ ì§œ í•„í„° -->
<input type="datetime-local" id="beforeDate">
<input type="datetime-local" id="afterDate">
<button onclick="loadMyParticipations(userId)">ì¡°íšŒ</button>

<ul id="participationList"></ul>
    <!-- ì—¬ê¸°ì— ìë™ìœ¼ë¡œ ëª©ë¡ì´ ì¶œë ¥ë¨ -->
</ul>

</body>
</html>
